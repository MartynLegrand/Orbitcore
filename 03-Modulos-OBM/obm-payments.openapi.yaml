openapi: 3.0.3
info:
  title: obm-payments API
  version: v1
servers:
  - url: http://localhost:3002
paths:
  /api/payments/charge:
    post:
      summary: Create charge
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChargeRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChargeResponse'
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorEnvelope'
  /api/payments/webhook:
    post:
      summary: Payment webhook
      parameters:
        - name: X-Signature
          in: header
          required: true
          schema: { type: string }
        - name: X-Event-Id
          in: header
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookEvent'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
  /api/payments/subscriptions:
    get:
      summary: List subscriptions
      parameters:
        - name: customerId
          in: query
          required: true
          schema: { type: string }
        - name: page
          in: query
          schema: { type: integer, default: 1 }
        - name: pageSize
          in: query
          schema: { type: integer, default: 20 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubscriptionsResponse'
components:
  schemas:
    Meta:
      type: object
      properties:
        version: { type: string }
        traceId: { type: string }
        timestamp: { type: string, format: date-time }
    ErrorEnvelope:
      type: object
      properties:
        status: { type: string, enum: [error] }
        error:
          type: object
          properties:
            code: { type: string }
            message: { type: string }
            details: { type: object }
        meta: { $ref: '#/components/schemas/Meta' }
    ChargeRequest:
      type: object
      required: [amount, currency, customerId]
      properties:
        amount: { type: integer }
        currency: { type: string }
        customerId: { type: string }
        methodId: { type: string }
        idempotencyKey: { type: string }
    ChargeResponse:
      type: object
      properties:
        status: { type: string, enum: [success] }
        data:
          type: object
          properties:
            chargeId: { type: string }
            status: { type: string }
            receiptUrl: { type: string }
        meta: { $ref: '#/components/schemas/Meta' }
    WebhookEvent:
      type: object
      properties:
        type: { type: string }
        data: { type: object }
    WebhookResponse:
      type: object
      properties:
        status: { type: string, enum: [success] }
        data:
          type: object
          properties:
            processed: { type: boolean }
        meta: { $ref: '#/components/schemas/Meta' }
    SubscriptionItem:
      type: object
      properties:
        id: { type: string }
        plan: { type: string }
    SubscriptionsResponse:
      type: object
      properties:
        status: { type: string, enum: [success] }
        data:
          type: object
          properties:
            items: { type: array, items: { $ref: '#/components/schemas/SubscriptionItem' } }
            page: { type: integer }
            pageSize: { type: integer }
            total: { type: integer }
        meta: { $ref: '#/components/schemas/Meta' }